var base_pricemod=1.2,base_buyback=.6;angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("dig",["ngAnimate","underscore","LocalStorageModule"]).factory("animate",["$window","$rootScope",function(e,n){Date.now||(Date.now=function(){return(new Date).getTime()}),function(){for(var e=["webkit","moz"],n=0;n<e.length&&!window.requestAnimationFrame;++n){var t=e[n];window.requestAnimationFrame=window[t+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t+"CancelAnimationFrame"]||window[t+"CancelRequestAnimationFrame"]}if(/iP(ad|hone|od).*OS 6/.test(window.navigator.userAgent)||!window.requestAnimationFrame||!window.cancelAnimationFrame){var a=0;window.requestAnimationFrame=function(e){var n=Date.now(),t=Math.max(a+16,n);return setTimeout(function(){e(a=t)},t-n)},window.cancelAnimationFrame=clearTimeout}}();var t=e.requestAnimationFrame;return function(e){t(function(t){n.$apply(function(){e(t)})})}}]).directive("display",["$window","$document","animate",function(e,n,t){return{scope:!0,restrict:"A",template:['<div class="wrapper"></div>','<div class="horizon" style="background-position: 0px -{{bgPos(depth)}}px;">','<div class="inner" data-depth="{{depth | number:0}}" style="height: {{holeHeight(depth) || \'100%\'}}; width: {{holeWidth()}}px; background-position: 0px -{{bgPos(depth)}}px;">','<div data-ng-repeat="item in displayArray | orderBy:\'$index\':true track by $index" class="miniondiv" style="width: {{holeWidth()}}px;">','<span data-ng-repeat="count in ngArray(item.owned) track by $index">','<img class="{{item.name | lowercase}}" data-ng-src="dist/img/{{item.name | lowercase}}.svg" />',"</span>","</div>","</div>","</div>"].join("\n"),link:function(a){var o=angular.element(e).height();a.holeHeight=function(e){return o>.2*e?.2*e+"px":void 0},a.bgPos=function(e){return o>.2*e?0:.2*(e-o)},a.holeWidth=function(){return Math.min(700,Math.max(350,_(a.shop).reduce(function(e,n){return e+n.owned*n.digValue},0)))},a.displayArray=[],a.$watch("shop",function(){a.displayArray=_.values(a.shop).reverse()}),function r(){angular.element(e).scrollTop(n.height()),t(r)}()}}}]).service("configuration",["$http",function(e){return{load:function(n,t){return e.get(t?n:n)}}}]).service("gamestate",["localStorageService",function(e){return{load:function(){return e.get("saveData")},save:function(n){return e.set("saveData",n)}}}]).controller("game",["$scope","$timeout","$document","configuration","animate","gamestate",function(e,n,t,a,o,r){e.depth=0,e.funds=0,e.digValue=1,e.shop={},e.upgrades={},e.achievements=[],a.load("configuration.json",!0).success(function(n){e.shop=n.shop,e.upgrades=n.upgrades,e.achievements=n.achievements;var t=r.load();t&&(console.log("saveData:depth",t.depth,parseFloat(t.depth)),console.log("saveData:funds",t.funds,parseFloat(t.funds)),e.depth=parseFloat(t.depth),e.funds=parseFloat(t.funds),e.shop=_.merge(e.shop,t.shop),e.upgrades=_.merge(e.upgrades,t.upgrades))}).error(function(){console.log("ERROR")}),e.currentCost=function(n){return Math.round(e.shop[n].cost*Math.pow(base_pricemod,e.shop[n].owned))},e.dig=function(n){var t=n||e.digValue;e.funds+=t,e.depth+=t/5},e.purchaseShopItem=function(n){n&&e.funds>=e.currentCost(n)&&(e.funds-=e.currentCost(n),e.shop[n].owned+=1)},e.sellShopItem=function(n){n&&e.shop[n].owned>0&&(e.funds+=Math.round(e.currentCost(n)*base_buyback),e.shop[n].owned-=1)},e.purchaseUpgradeItem=function(n){n&&e.funds>=e.upgrades[n].cost&&(e.$eval(e.upgrades[n].effect),e.funds-=e.upgrades[n].cost,e.upgrades[n].enabled=!0)},e.showUpgradeItem=function(n){return e.$eval(n)},e.ngArray=function(e){return new Array(e)};var i=0,u=null;o(function s(n){u||(u=n);var t=n-u;u=n;var a=_(e.shop).filter(function(e){return e.owned}).reduce(function(e,n){return e+n.owned*n.digValue*t*n.cycle},0);a&&e.dig(a/1e3),_(e.upgrades).filter(function(e){return!e.available}).each(function(n){n.available=e.$eval(n.unlocks)?!0:!1}),_(e.achievements).filter(function(e){return!e.nailed}).each(function(n){n.nailed=e.$eval(n.criteria)?!0:!1}),i++,i%300===0&&r.save({depth:Math.round(100*e.depth)/100,funds:Math.round(100*e.funds)/100,shop:_.mapValues(e.shop,function(e){return _.pick(e,"owned")}),upgrades:_(e.upgrades).filter(function(e){return e.available}).mapValues(function(e){return _.pick(e,"enabled")}).valueOf()}),o(s)})}]).controller("tabs",["$scope",function(e){e.tab_shop=!0,e.tab_upgrades=!1,e.tab_achievements=!1}]);